name: CI/CD Pipeline

on:
  push:
    branches: [ main, dev, preview ]
  pull_request:
    branches: [ main, dev, preview ]

jobs:
  # Detect what has changed
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      web-changed: ${{ steps.changes.outputs.web }}
      ios-changed: ${{ steps.changes.outputs.ios }}
      root-changed: ${{ steps.changes.outputs.root }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            web:
              - 'apps/web/**'
            ios:
              - 'apps/ios/**'
            root:
              - 'package.json'
              - 'package-lock.json'
              - '.github/**'
              - 'turbo.json'

  # Web app CI/CD (existing logic)
  web-ci:
    needs: detect-changes
    if: needs.detect-changes.outputs.web-changed == 'true' || needs.detect-changes.outputs.root-changed == 'true'
    runs-on: ubuntu-latest
    continue-on-error: true

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linter (Web)
      run: npm run lint
      working-directory: apps/web
      continue-on-error: true

    - name: Run type check (Web)
      run: npm run typecheck
      working-directory: apps/web

    - name: Run tests (Web)
      run: npm test -- --passWithNoTests
      working-directory: apps/web
      env:
        CI: true
      continue-on-error: true

    - name: Build (Web)
      run: npm run build
      working-directory: apps/web
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co' }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder-key' }}
        NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY || 'pk_test_placeholder' }}

  # iOS CI/CD Pipeline
  ios-ci:
    needs: detect-changes
    if: needs.detect-changes.outputs.ios-changed == 'true'
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Install dependencies
      run: |
        cd apps/ios
        # Install SwiftLint
        brew install swiftlint
        # Create placeholder Supabase.xcconfig for CI
        if [ ! -f "Supabase.xcconfig" ]; then
          echo "// Supabase Configuration (CI Placeholder)" > Supabase.xcconfig
          echo "SUPABASE_URL = https://placeholder.supabase.co" >> Supabase.xcconfig
          echo "SUPABASE_ANON_KEY = placeholder-anon-key" >> Supabase.xcconfig
        fi
        # Create placeholder Config.xcconfig for CI
        if [ ! -f "LogYourBody/Config.xcconfig" ]; then
          echo "// Configuration (CI Placeholder)" > LogYourBody/Config.xcconfig
          echo "CLERK_PUBLISHABLE_KEY = placeholder-clerk-key" >> LogYourBody/Config.xcconfig
        fi
        # Install CocoaPods if needed
        if [ -f "Podfile" ]; then
          sudo gem install cocoapods
          pod install
        fi

    - name: Run SwiftLint Check
      run: |
        cd apps/ios
        echo "Running SwiftLint..."
        swiftlint lint --strict --reporter github-actions-logging
        echo "âœ… SwiftLint passed with no violations"

    - name: Build iOS App
      run: |
        cd apps/ios
        xcodebuild -project LogYourBody.xcodeproj \
          -scheme LogYourBody \
          -destination 'platform=iOS Simulator,name=iPhone 16' \
          clean build
      env:
        CODE_SIGNING_REQUIRED: NO

    - name: Run iOS Tests
      run: |
        cd apps/ios
        xcodebuild -project LogYourBody.xcodeproj \
          -scheme LogYourBody \
          -destination 'platform=iOS Simulator,name=iPhone 16' \
          test
      continue-on-error: true

    - name: Archive for TestFlight (if on dev branch)
      if: github.ref == 'refs/heads/dev' && github.event_name == 'push'
      run: |
        cd apps/ios
        xcodebuild -project LogYourBody.xcodeproj \
          -scheme LogYourBody \
          -configuration Release \
          -archivePath build/LogYourBody.xcarchive \
          archive
      env:
        CODE_SIGN_IDENTITY: ${{ secrets.IOS_CODE_SIGN_IDENTITY }}
        PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE }}

  # Auto-merge to preview branch on successful iOS CI
  ios-auto-merge:
    needs: [detect-changes, ios-ci]
    if: needs.detect-changes.outputs.ios-changed == 'true' && github.ref == 'refs/heads/dev' && github.event_name == 'push'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Auto-merge to preview
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Fetch latest changes
        git fetch origin preview
        
        # Switch to preview branch or create it
        git checkout preview || git checkout -b preview
        
        # Merge dev into preview
        git merge origin/dev --no-ff -m "Auto-merge dev to preview after successful iOS CI"
        
        # Push to preview
        git push origin preview

  # TestFlight deployment from preview branch
  testflight-deploy:
    if: github.ref == 'refs/heads/preview' && github.event_name == 'push'
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Install dependencies
      run: |
        cd apps/ios
        if [ -f "Podfile" ]; then
          sudo gem install cocoapods
          pod install
        fi

    - name: Import Code Signing Certificates
      uses: apple-actions/import-codesign-certs@v2
      with:
        p12-file-base64: ${{ secrets.IOS_P12_BASE64 }}
        p12-password: ${{ secrets.IOS_P12_PASSWORD }}

    - name: Download Provisioning Profile
      run: |
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        echo "${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/distribution.mobileprovision

    - name: Build and Archive for TestFlight
      run: |
        cd apps/ios
        
        # Increment build number
        BUILD_NUMBER=$(date +%Y%m%d%H%M%S)
        /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" LogYourBody/Info.plist
        
        # Archive
        xcodebuild -project LogYourBody.xcodeproj \
          -scheme LogYourBody \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          -archivePath build/LogYourBody.xcarchive \
          archive
        
        # Export IPA
        xcodebuild -exportArchive \
          -archivePath build/LogYourBody.xcarchive \
          -exportOptionsPlist ExportOptions.plist \
          -exportPath build/

    - name: Upload to TestFlight
      run: |
        cd apps/ios
        xcrun altool --upload-app \
          --type ios \
          --file build/LogYourBody.ipa \
          --username "${{ secrets.APPLE_ID_EMAIL }}" \
          --password "${{ secrets.APPLE_ID_PASSWORD }}"

  # Lint job for Web
  lint-web:
    needs: detect-changes
    if: needs.detect-changes.outputs.web-changed == 'true' || needs.detect-changes.outputs.root-changed == 'true'
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js
      if: needs.detect-changes.outputs.web-changed == 'true' || needs.detect-changes.outputs.root-changed == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies (Web)
      if: needs.detect-changes.outputs.web-changed == 'true' || needs.detect-changes.outputs.root-changed == 'true'
      run: npm ci

    - name: Run ESLint (Web)
      if: needs.detect-changes.outputs.web-changed == 'true' || needs.detect-changes.outputs.root-changed == 'true'
      run: npm run lint -- --max-warnings 0
      working-directory: apps/web
      continue-on-error: true

  # Lint job for iOS
  lint-ios:
    needs: detect-changes
    if: needs.detect-changes.outputs.ios-changed == 'true'
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Install SwiftLint
      run: |
        brew install swiftlint

    - name: Run SwiftLint
      run: |
        cd apps/ios
        # Run SwiftLint with strict mode - fail on any violation
        swiftlint lint --strict --reporter github-actions-logging
      env:
        SWIFTLINT_STRICT: true

