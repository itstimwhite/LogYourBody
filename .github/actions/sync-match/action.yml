name: 'Sync Certificates with Match'
description: 'Sync certificates and provisioning profiles using Fastlane match'
inputs:
  match_password:
    description: 'Passphrase for Fastlane match (MATCH_PASSWORD)'
    required: true
  match_git_url:
    description: 'Git URL for Fastlane match repository (MATCH_GIT_URL)'
    required: true
  match_git_basic:
    description: 'Basic auth credentials for git (username:password), embedded in URL'
    required: false
  match_git_branch:
    description: 'Git branch to use for Match certificates'
    required: false
outputs:
  profile_uuid:
    description: 'The UUID of the provisioning profile'
    value: ${{ steps.match.outputs.profile_uuid }}
  profile_name:
    description: 'The name of the provisioning profile'
    value: ${{ steps.match.outputs.profile_name }}
runs:
  using: 'composite'
  steps:
    - name: Setup Ruby and Bundler
      uses: ./.github/actions/setup-ruby-bundler
      with:
        working-directory: apps/ios
        cache-key-prefix: 'match-gems'
    - name: Sync certificates and provisioning profiles
      id: match
      shell: bash
      working-directory: apps/ios
      run: |
        if [ -z "$MATCH_GIT_URL" ] || [ -z "$MATCH_GIT_BASIC_AUTHORIZATION" ]; then
          echo "::error::Missing MATCH_GIT_URL or MATCH_GIT_BASIC_AUTHORIZATION secrets. See .github/workflows/ios-secrets-setup.md"
          exit 1
        fi
        # Use our setup_provisioning lane which handles API key setup properly
        # Run in readonly mode since certificates exist
        bundle exec fastlane setup_provisioning type:appstore readonly:true
        
        # Export the provisioning profile info for use in later steps
        # Check if the profile was installed and get its details
        PROFILE_PATH="$HOME/Library/MobileDevice/Provisioning Profiles/"
        LATEST_PROFILE=$(ls -t "$PROFILE_PATH"*.mobileprovision 2>/dev/null | head -1)
        
        if [ -n "$LATEST_PROFILE" ]; then
          # Extract UUID from filename
          PROFILE_UUID=$(basename "$LATEST_PROFILE" .mobileprovision)
          echo "profile_uuid=$PROFILE_UUID" >> $GITHUB_OUTPUT
          echo "profile_name=match AppStore LogYourBody.LogYourBody" >> $GITHUB_OUTPUT
          echo "Found provisioning profile: $PROFILE_UUID"
        else
          echo "Warning: Could not find installed provisioning profile"
        fi
      env:
        MATCH_PASSWORD: ${{ inputs.match_password }}
        MATCH_GIT_URL: ${{ inputs.match_git_url }}
        MATCH_GIT_BASIC_AUTHORIZATION: ${{ inputs.match_git_basic }}
        MATCH_GIT_BRANCH: ${{ inputs.match_git_branch }}
        MATCH_KEYCHAIN_NAME: login.keychain
        MATCH_KEYCHAIN_PASSWORD: 
        FL_OUTPUT_DIR: ./logs
        FASTLANE_HIDE_TIMESTAMP: true
