import{a}from"./react-vendor-CGPzL8fz.js";import{g as P,s as _}from"./index-BWixOZri.js";import{u as Q,b as $}from"./data-vendor-Dz4nk24n.js";import{J as v}from"./utils-vendor-BD55slVq.js";function F({queryFn:r,timeout:n=3e3,retryOnTimeout:u=!0,onTimeout:c,showTimeoutToast:w=!0,...m}){const T=Q(),f=a.useRef(null),[E,h]=a.useState({isTimedOut:!1,retryCount:0}),s=$({...m,queryFn:async()=>{f.current&&f.current.abort(),f.current=new AbortController;const o=f.current.signal,g=new Promise((y,p)=>{const D=setTimeout(()=>{h(S=>({...S,isTimedOut:!0})),c&&c(),w&&v.error("Still loadingâ€¦",{description:"The request is taking longer than expected. Please check your connection.",action:{label:"Retry",onClick:()=>{h(S=>({...S,isTimedOut:!1,retryCount:S.retryCount+1})),T.invalidateQueries({queryKey:m.queryKey})}}}),p(new Error("Query timeout"))},n);o.addEventListener("abort",()=>{clearTimeout(D),p(new Error("Query aborted"))})}),b=r();try{const y=await Promise.race([b,g]);return h(p=>({...p,isTimedOut:!1})),y}catch(y){throw y instanceof Error&&y.message==="Query timeout"&&u,y}},staleTime:m.staleTime??1/0,gcTime:m.gcTime??24*60*60*1e3,retry:(o,g)=>g instanceof Error&&g.message==="Query aborted"?!1:g instanceof Error&&g.message==="Query timeout"?u&&o<3:m.retry!==!1&&o<3,retryDelay:o=>Math.min(1e3*2**o,3e4)});return a.useEffect(()=>()=>{f.current&&f.current.abort()},[]),{...s,isTimedOut:E.isTimedOut,retryCount:E.retryCount,retryQuery:()=>{h(o=>({...o,isTimedOut:!1,retryCount:o.retryCount+1})),T.invalidateQueries({queryKey:m.queryKey})}}}function L(r){return r/2.20462}function C(r){return r*2.20462}function M(r){const n=r/2.54,u=Math.floor(n/12),c=Math.round(n%12);return`${u}'${c}"`}function U(r){return r/2.54}function x(r,n){return!r||r<=0||isNaN(r)?0:!n||n<0||n>100||isNaN(n)?r:r*(1-n/100)}function K(r,n){if(!r||r<=0||isNaN(r)||!n||n<=0||isNaN(n))return 0;const u=n/100,c=r/(u*u);return isNaN(c)||!isFinite(c)?0:c}function G(){const{user:r}=P(),n=Q(),[u,c]=a.useState(0),w=async()=>{if(!r?.id)return null;const{data:e,error:t}=await _.from("profiles").select("*").eq("id",r.id).single();if(t&&t.code!=="PGRST116")throw new Error(`Failed to fetch profile: ${t.message}`);return e&&e.birthday&&(e.birthday=new Date(e.birthday)),e},m=async()=>{if(!r?.id)return null;const{data:e,error:t}=await _.from("user_settings").select("*").eq("user_id",r.id).single();return t&&t.code!=="PGRST116"?{userId:r.id,units:"imperial",healthKitSyncEnabled:!1,googleFitSyncEnabled:!1}:e},T=async()=>{if(!r?.id)return[];const{data:e,error:t}=await _.from("body_metrics").select("*").eq("user_id",r.id).order("date",{ascending:!0});if(t)throw new Error(`Failed to fetch metrics: ${t.message}`);return(e||[]).map(d=>({...d,date:new Date(d.date),stepCount:d.step_count??void 0,photoUrl:d.photo_url??void 0}))},f=F({queryKey:["profile",r?.id],queryFn:w,enabled:!!r?.id}),E=F({queryKey:["settings",r?.id],queryFn:m,enabled:!!r?.id}),h=F({queryKey:["metrics",r?.id],queryFn:T,enabled:!!r?.id}),l=f.data||null,s=E.data||null,o=h.data||[],g=f.isLoading||E.isLoading||h.isLoading;a.useEffect(()=>{o.length>0&&u===0&&c(Math.max(0,o.length-1))},[o.length,u]);const b=a.useMemo(()=>[...o].sort((e,t)=>{try{const i=e.date instanceof Date?e.date:new Date(e.date),d=t.date instanceof Date?t.date:new Date(t.date);return isNaN(i.getTime())||isNaN(d.getTime())?(console.warn("Invalid date in metrics:",{a:e.date,b:t.date}),0):i.getTime()-d.getTime()}catch(i){return console.error("Error sorting metrics by date:",i),0}}),[o]),y=a.useMemo(()=>{const e=b[u];if(!e||!l)return{bodyFatPercentage:0,weight:0,ffmi:0,leanBodyMass:0,stepCount:0,date:new Date};const t=x(e.weight,e.bodyFatPercentage),i=K(t,l.height);return{bodyFatPercentage:e.bodyFatPercentage,weight:e.weight,ffmi:Math.round(i*10)/10,leanBodyMass:Math.round(t*10)/10,stepCount:e.stepCount,date:e.date}},[b,u,l]),p=a.useCallback(async e=>{if(r)try{const{data:t,error:i}=await _.from("body_metrics").insert({user_id:r.id,date:e.date.toISOString().split("T")[0],weight:e.weight,body_fat_percentage:e.bodyFatPercentage,method:e.method,step_count:e.stepCount??null,photo_url:e.photoUrl??null}).select().single();if(i){console.error("Error adding metric:",i);return}t&&(n.invalidateQueries({queryKey:["metrics",r.id]}),c(b.length))}catch(t){console.error("Error in addMetric:",t)}},[r,b.length]),D=a.useCallback(async e=>{if(!(!r||!l))try{const t={};e.name&&(t.name=e.name),e.email&&(t.email=e.email),e.gender&&(t.gender=e.gender),e.birthday&&(t.birthday=e.birthday.toISOString().split("T")[0]),e.height&&(t.height=e.height),e.profileImage&&(t.profile_image_url=e.profileImage),t.updated_at=new Date().toISOString();const{error:i}=await _.from("profiles").update(t).eq("id",r.id);if(i){console.error("Error updating user:",i);return}n.invalidateQueries({queryKey:["profile",r.id]})}catch(t){console.error("Error in updateUser:",t)}},[r,l]),S=a.useCallback(async e=>{if(!(!r||!s))try{const t={};e.units&&(t.units=e.units),e.healthKitSyncEnabled!==void 0&&(t.health_kit_sync_enabled=e.healthKitSyncEnabled),e.googleFitSyncEnabled!==void 0&&(t.google_fit_sync_enabled=e.googleFitSyncEnabled),t.updated_at=new Date().toISOString();const{error:i}=await _.from("user_settings").update(t).eq("user_id",r.id);if(i){console.error("Error updating settings:",i);return}n.invalidateQueries({queryKey:["settings",r.id]})}catch(t){console.error("Error in updateSettings:",t)}},[r,s]),k=a.useCallback(e=>{if(!s)return"0 kg";if(!e||e<=0||isNaN(e))return s.units==="metric"?"0 kg":"0 lbs";if(s.units==="metric")return`${Math.round(e*10)/10} kg`;{const t=C(e);return`${Math.round(t*10)/10} lbs`}},[s]),q=a.useCallback(e=>s?s.units==="metric"?`${e} cm`:M(e):`${e} cm`,[s]),N=a.useCallback(e=>{if(!s)return"0 kg";if(!e||e<=0||isNaN(e))return s.units==="metric"?"0 kg":"0 lbs";if(s.units==="metric")return`${Math.round(e*10)/10} kg`;{const t=C(e);return`${Math.round(t*10)/10} lbs`}},[s]),I=a.useCallback(()=>{if(!l)return 0;const e=new Date,t=new Date(l.birthday);let i=e.getFullYear()-t.getFullYear();const d=e.getMonth()-t.getMonth();return(d<0||d===0&&e.getDate()<t.getDate())&&i--,i},[l]);return{user:l,metrics:b,currentMetrics:y,selectedDateIndex:u,setSelectedDateIndex:c,addMetric:p,updateUser:D,getUserAge:I,settings:s,updateSettings:S,getFormattedWeight:k,getFormattedHeight:q,getFormattedLeanBodyMass:N,loading:g,utils:{lbsToKg:L,kgToLbs:C,cmToFeet:M,cmToInches:U}}}export{F as a,G as u};
