import{v as L,j as f,w as U,x as M,y as B,z as Q,O as q,B as v}from"./ui-vendor-B29bBmtv.js";import{a as o}from"./react-vendor-CGPzL8fz.js";import{c as S,u as K,s as w}from"./index-BXn5fie0.js";import{X as z,J as A}from"./utils-vendor-eZsCaz-O.js";import{u as I,b as H}from"./data-vendor-CtvEhjhB.js";const ie=L,G=U,P=o.forwardRef(({className:t,...a},n)=>f.jsx(q,{ref:n,className:S("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",t),...a}));P.displayName=q.displayName;const J=o.forwardRef(({className:t,children:a,...n},l)=>f.jsxs(G,{children:[f.jsx(P,{}),f.jsxs(M,{ref:l,className:S("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",t),...n,children:[a,f.jsxs(B,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[f.jsx(z,{className:"h-4 w-4"}),f.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));J.displayName=M.displayName;const Y=({className:t,...a})=>f.jsx("div",{className:S("flex flex-col space-y-1.5 text-center sm:text-left",t),...a});Y.displayName="DialogHeader";const W=o.forwardRef(({className:t,...a},n)=>f.jsx(Q,{ref:n,className:S("text-lg font-semibold leading-none tracking-tight",t),...a}));W.displayName=Q.displayName;const X=o.forwardRef(({className:t,...a},n)=>f.jsx(v,{ref:n,className:S("text-sm text-muted-foreground",t),...a}));X.displayName=v.displayName;function C({queryFn:t,timeout:a=3e3,retryOnTimeout:n=!0,onTimeout:l,showTimeoutToast:E=!0,...y}){const T=I(),m=o.useRef(null),[x,p]=o.useState({isTimedOut:!1,retryCount:0}),i=H({...y,queryFn:async()=>{m.current&&m.current.abort(),m.current=new AbortController;const c=m.current.signal,h=new Promise((g,N)=>{const _=setTimeout(()=>{p(D=>({...D,isTimedOut:!0})),l&&l(),E&&A.error("Still loadingâ€¦",{description:"The request is taking longer than expected. Please check your connection.",action:{label:"Retry",onClick:()=>{p(D=>({...D,isTimedOut:!1,retryCount:D.retryCount+1})),T.invalidateQueries({queryKey:y.queryKey})}}}),N(new Error("Query timeout"))},a);c.addEventListener("abort",()=>{clearTimeout(_),N(new Error("Query aborted"))})}),b=t();try{const g=await Promise.race([b,h]);return p(N=>({...N,isTimedOut:!1})),g}catch(g){throw g instanceof Error&&g.message==="Query timeout"&&n,g}},staleTime:y.staleTime??1/0,gcTime:y.gcTime??24*60*60*1e3,retry:(c,h)=>h instanceof Error&&h.message==="Query aborted"?!1:h instanceof Error&&h.message==="Query timeout"?n&&c<3:y.retry!==!1&&c<3,retryDelay:c=>Math.min(1e3*2**c,3e4)});return o.useEffect(()=>()=>{m.current&&m.current.abort()},[]),{...i,isTimedOut:x.isTimedOut,retryCount:x.retryCount,retryQuery:()=>{p(c=>({...c,isTimedOut:!1,retryCount:c.retryCount+1})),T.invalidateQueries({queryKey:y.queryKey})}}}function V(t){return t/2.20462}function k(t){return t*2.20462}function F(t){const a=t/2.54,n=Math.floor(a/12),l=Math.round(a%12);return`${n}'${l}"`}function Z(t){return t/2.54}function ee(t,a){return!t||t<=0||isNaN(t)?0:!a||a<0||a>100||isNaN(a)?t:t*(1-a/100)}function te(t,a){if(!t||t<=0||isNaN(t)||!a||a<=0||isNaN(a))return 0;const n=a/100,l=t/(n*n);return isNaN(l)||!isFinite(l)?0:l}function ce(){const{user:t}=K(),a=I(),[n,l]=o.useState(0),E=async()=>{if(!t?.id)return null;const{data:e,error:r}=await w.from("profiles").select("*").eq("id",t.id).single();if(r&&r.code!=="PGRST116")throw new Error(`Failed to fetch profile: ${r.message}`);return e&&e.birthday&&(e.birthday=new Date(e.birthday)),e},y=async()=>{if(!t?.id)return null;const{data:e,error:r}=await w.from("user_settings").select("*").eq("user_id",t.id).single();return r&&r.code!=="PGRST116"?{userId:t.id,units:"imperial",healthKitSyncEnabled:!1,googleFitSyncEnabled:!1}:e},T=async()=>{if(!t?.id)return[];const{data:e,error:r}=await w.from("body_metrics").select("*").eq("user_id",t.id).order("date",{ascending:!0});if(r)throw new Error(`Failed to fetch metrics: ${r.message}`);return(e||[]).map(u=>({...u,date:new Date(u.date),stepCount:u.step_count??void 0,photoUrl:u.photo_url??void 0}))},m=C({queryKey:["profile",t?.id],queryFn:E,enabled:!!t?.id}),x=C({queryKey:["settings",t?.id],queryFn:y,enabled:!!t?.id}),p=C({queryKey:["metrics",t?.id],queryFn:T,enabled:!!t?.id}),d=m.data||null,i=x.data||null,c=p.data||[],h=m.isLoading||x.isLoading||p.isLoading;o.useEffect(()=>{c.length>0&&n===0&&l(Math.max(0,c.length-1))},[c.length,n]);const b=o.useMemo(()=>[...c].sort((e,r)=>{try{const s=e.date instanceof Date?e.date:new Date(e.date),u=r.date instanceof Date?r.date:new Date(r.date);return isNaN(s.getTime())||isNaN(u.getTime())?(console.warn("Invalid date in metrics:",{a:e.date,b:r.date}),0):s.getTime()-u.getTime()}catch(s){return console.error("Error sorting metrics by date:",s),0}}),[c]),g=o.useMemo(()=>{const e=b[n];if(!e||!d)return{bodyFatPercentage:0,weight:0,ffmi:0,leanBodyMass:0,stepCount:0,date:new Date};const r=ee(e.weight,e.bodyFatPercentage),s=te(r,d.height);return{bodyFatPercentage:e.bodyFatPercentage,weight:e.weight,ffmi:Math.round(s*10)/10,leanBodyMass:Math.round(r*10)/10,stepCount:e.stepCount,date:e.date}},[b,n,d]),N=o.useCallback(async e=>{if(t)try{const{data:r,error:s}=await w.from("body_metrics").insert({user_id:t.id,date:e.date.toISOString().split("T")[0],weight:e.weight,body_fat_percentage:e.bodyFatPercentage,method:e.method,step_count:e.stepCount??null,photo_url:e.photoUrl??null}).select().single();if(s){console.error("Error adding metric:",s);return}r&&(a.invalidateQueries({queryKey:["metrics",t.id]}),l(b.length))}catch(r){console.error("Error in addMetric:",r)}},[t,b.length]),_=o.useCallback(async e=>{if(!(!t||!d))try{const r={};e.name&&(r.name=e.name),e.email&&(r.email=e.email),e.gender&&(r.gender=e.gender),e.birthday&&(r.birthday=e.birthday.toISOString().split("T")[0]),e.height&&(r.height=e.height),e.profileImage&&(r.profile_image_url=e.profileImage),r.updated_at=new Date().toISOString();const{error:s}=await w.from("profiles").update(r).eq("id",t.id);if(s){console.error("Error updating user:",s);return}a.invalidateQueries({queryKey:["profile",t.id]})}catch(r){console.error("Error in updateUser:",r)}},[t,d]),D=o.useCallback(async e=>{if(!(!t||!i))try{const r={};e.units&&(r.units=e.units),e.healthKitSyncEnabled!==void 0&&(r.health_kit_sync_enabled=e.healthKitSyncEnabled),e.googleFitSyncEnabled!==void 0&&(r.google_fit_sync_enabled=e.googleFitSyncEnabled),r.updated_at=new Date().toISOString();const{error:s}=await w.from("user_settings").update(r).eq("user_id",t.id);if(s){console.error("Error updating settings:",s);return}a.invalidateQueries({queryKey:["settings",t.id]})}catch(r){console.error("Error in updateSettings:",r)}},[t,i]),j=o.useCallback(e=>{if(!i)return"0 kg";if(!e||e<=0||isNaN(e))return i.units==="metric"?"0 kg":"0 lbs";if(i.units==="metric")return`${Math.round(e*10)/10} kg`;{const r=k(e);return`${Math.round(r*10)/10} lbs`}},[i]),R=o.useCallback(e=>i?i.units==="metric"?`${e} cm`:F(e):`${e} cm`,[i]),$=o.useCallback(e=>{if(!i)return"0 kg";if(!e||e<=0||isNaN(e))return i.units==="metric"?"0 kg":"0 lbs";if(i.units==="metric")return`${Math.round(e*10)/10} kg`;{const r=k(e);return`${Math.round(r*10)/10} lbs`}},[i]),O=o.useCallback(()=>{if(!d)return 0;const e=new Date,r=new Date(d.birthday);let s=e.getFullYear()-r.getFullYear();const u=e.getMonth()-r.getMonth();return(u<0||u===0&&e.getDate()<r.getDate())&&s--,s},[d]);return{user:d,metrics:b,currentMetrics:g,selectedDateIndex:n,setSelectedDateIndex:l,addMetric:N,updateUser:_,getUserAge:O,settings:i,updateSettings:D,getFormattedWeight:j,getFormattedHeight:R,getFormattedLeanBodyMass:$,loading:h,utils:{lbsToKg:V,kgToLbs:k,cmToFeet:F,cmToInches:Z}}}export{ie as D,J as a,Y as b,W as c,C as d,ce as u};
