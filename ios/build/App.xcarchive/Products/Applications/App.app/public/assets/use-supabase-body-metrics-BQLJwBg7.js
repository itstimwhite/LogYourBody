import{z as L,j as u,B,E as Q,F as K,G as q,O as C,H as I}from"./ui-vendor-QE-oobKj.js";import{a as i}from"./react-vendor-ClhmtWht.js";import{g as E,u as z,s as w}from"./index-D69SCsvj.js";import{X as U,J as A}from"./utils-vendor-BycXaddh.js";import{u as v,b as H}from"./data-vendor-DLfSSb0Z.js";const oe=L,G=B,P=i.forwardRef(({className:t,...a},n)=>u.jsx(C,{ref:n,className:E("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",t),...a}));P.displayName=C.displayName;const J=i.forwardRef(({className:t,children:a,...n},d)=>u.jsxs(G,{children:[u.jsx(P,{}),u.jsxs(Q,{ref:d,className:E("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",t),...n,children:[a,u.jsxs(K,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[u.jsx(U,{className:"h-4 w-4"}),u.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));J.displayName=Q.displayName;const Y=({className:t,...a})=>u.jsx("div",{className:E("flex flex-col space-y-1.5 text-center sm:text-left",t),...a});Y.displayName="DialogHeader";const W=i.forwardRef(({className:t,...a},n)=>u.jsx(q,{ref:n,className:E("text-lg font-semibold leading-none tracking-tight",t),...a}));W.displayName=q.displayName;const X=i.forwardRef(({className:t,...a},n)=>u.jsx(I,{ref:n,className:E("text-sm text-muted-foreground",t),...a}));X.displayName=I.displayName;function F({queryFn:t,timeout:a=3e3,retryOnTimeout:n=!0,onTimeout:d,showTimeoutToast:T=!0,...g}){const S=v(),f=i.useRef(null),[x,b]=i.useState({isTimedOut:!1,retryCount:0}),o=H({...g,queryFn:async()=>{f.current&&f.current.abort(),f.current=new AbortController;const c=f.current.signal,y=new Promise((m,N)=>{const k=setTimeout(()=>{b(D=>({...D,isTimedOut:!0})),d&&d(),T&&A.error("Still loadingâ€¦",{description:"The request is taking longer than expected. Please check your connection.",action:{label:"Retry",onClick:()=>{b(D=>({...D,isTimedOut:!1,retryCount:D.retryCount+1})),S.invalidateQueries({queryKey:g.queryKey})}}}),N(new Error("Query timeout"))},a);c.addEventListener("abort",()=>{clearTimeout(k),N(new Error("Query aborted"))})}),p=t();try{const m=await Promise.race([p,y]);return b(N=>({...N,isTimedOut:!1})),m}catch(m){throw m instanceof Error&&m.message==="Query timeout"&&n,m}},staleTime:g.staleTime??1/0,gcTime:g.gcTime??24*60*60*1e3,retry:(c,y)=>y instanceof Error&&y.message==="Query aborted"?!1:y instanceof Error&&y.message==="Query timeout"?n&&c<3:g.retry!==!1&&c<3,retryDelay:c=>Math.min(1e3*2**c,3e4)});return i.useEffect(()=>()=>{f.current&&f.current.abort()},[]),{...o,isTimedOut:x.isTimedOut,retryCount:x.retryCount,retryQuery:()=>{b(c=>({...c,isTimedOut:!1,retryCount:c.retryCount+1})),S.invalidateQueries({queryKey:g.queryKey})}}}function V(t){return t/2.20462}function M(t){return t*2.20462}function _(t){const a=t/2.54,n=Math.floor(a/12),d=Math.round(a%12);return`${n}'${d}"`}function Z(t){return t/2.54}function ee(t,a){return!t||t<=0||isNaN(t)?0:!a||a<0||a>100||isNaN(a)?t:t*(1-a/100)}function te(t,a){if(!t||t<=0||isNaN(t)||!a||a<=0||isNaN(a))return 0;const n=a/100,d=t/(n*n);return isNaN(d)||!isFinite(d)?0:d}function ce(){const{user:t}=z(),a=v(),[n,d]=i.useState(0),T=async()=>{if(!t?.id)return null;const{data:e,error:r}=await w.from("profiles").select("*").eq("id",t.id).single();if(r&&r.code!=="PGRST116")throw new Error(`Failed to fetch profile: ${r.message}`);return e&&e.birthday&&(e.birthday=new Date(e.birthday)),e},g=async()=>{if(!t?.id)return null;const{data:e,error:r}=await w.from("user_settings").select("*").eq("user_id",t.id).single();return r&&r.code!=="PGRST116"?{userId:t.id,units:"imperial",healthKitSyncEnabled:!1,googleFitSyncEnabled:!1}:e},S=async()=>{if(!t?.id)return[];const{data:e,error:r}=await w.from("body_metrics").select("*").eq("user_id",t.id).order("date",{ascending:!0});if(r)throw new Error(`Failed to fetch metrics: ${r.message}`);return(e||[]).map(h=>({...h,date:new Date(h.date)}))},f=F({queryKey:["profile",t?.id],queryFn:T,enabled:!!t?.id}),x=F({queryKey:["settings",t?.id],queryFn:g,enabled:!!t?.id}),b=F({queryKey:["metrics",t?.id],queryFn:S,enabled:!!t?.id}),l=f.data||null,o=x.data||null,c=b.data||[],y=f.isLoading||x.isLoading||b.isLoading;i.useEffect(()=>{c.length>0&&n===0&&d(Math.max(0,c.length-1))},[c.length,n]);const p=i.useMemo(()=>[...c].sort((e,r)=>{try{const s=e.date instanceof Date?e.date:new Date(e.date),h=r.date instanceof Date?r.date:new Date(r.date);return isNaN(s.getTime())||isNaN(h.getTime())?(console.warn("Invalid date in metrics:",{a:e.date,b:r.date}),0):s.getTime()-h.getTime()}catch(s){return console.error("Error sorting metrics by date:",s),0}}),[c]),m=i.useMemo(()=>{const e=p[n];if(!e||!l)return{bodyFatPercentage:0,weight:0,ffmi:0,leanBodyMass:0,date:new Date};const r=ee(e.weight,e.bodyFatPercentage),s=te(r,l.height);return{bodyFatPercentage:e.bodyFatPercentage,weight:e.weight,ffmi:Math.round(s*10)/10,leanBodyMass:Math.round(r*10)/10,date:e.date}},[p,n,l]),N=i.useCallback(async e=>{if(t)try{const{data:r,error:s}=await w.from("body_metrics").insert({user_id:t.id,date:e.date.toISOString().split("T")[0],weight:e.weight,body_fat_percentage:e.bodyFatPercentage,method:e.method}).select().single();if(s){console.error("Error adding metric:",s);return}r&&(a.invalidateQueries({queryKey:["metrics",t.id]}),d(p.length))}catch(r){console.error("Error in addMetric:",r)}},[t,p.length]),k=i.useCallback(async e=>{if(!(!t||!l))try{const r={};e.name&&(r.name=e.name),e.email&&(r.email=e.email),e.gender&&(r.gender=e.gender),e.birthday&&(r.birthday=e.birthday.toISOString().split("T")[0]),e.height&&(r.height=e.height),e.profileImage&&(r.profile_image_url=e.profileImage),r.updated_at=new Date().toISOString();const{error:s}=await w.from("profiles").update(r).eq("id",t.id);if(s){console.error("Error updating user:",s);return}a.invalidateQueries({queryKey:["profile",t.id]})}catch(r){console.error("Error in updateUser:",r)}},[t,l]),D=i.useCallback(async e=>{if(!(!t||!o))try{const r={};e.units&&(r.units=e.units),e.healthKitSyncEnabled!==void 0&&(r.health_kit_sync_enabled=e.healthKitSyncEnabled),e.googleFitSyncEnabled!==void 0&&(r.google_fit_sync_enabled=e.googleFitSyncEnabled),r.updated_at=new Date().toISOString();const{error:s}=await w.from("user_settings").update(r).eq("user_id",t.id);if(s){console.error("Error updating settings:",s);return}a.invalidateQueries({queryKey:["settings",t.id]})}catch(r){console.error("Error in updateSettings:",r)}},[t,o]),j=i.useCallback(e=>{if(!o)return"0 kg";if(!e||e<=0||isNaN(e))return o.units==="metric"?"0 kg":"0 lbs";if(o.units==="metric")return`${Math.round(e*10)/10} kg`;{const r=M(e);return`${Math.round(r*10)/10} lbs`}},[o]),R=i.useCallback(e=>o?o.units==="metric"?`${e} cm`:_(e):`${e} cm`,[o]),$=i.useCallback(e=>{if(!o)return"0 kg";if(!e||e<=0||isNaN(e))return o.units==="metric"?"0 kg":"0 lbs";if(o.units==="metric")return`${Math.round(e*10)/10} kg`;{const r=M(e);return`${Math.round(r*10)/10} lbs`}},[o]),O=i.useCallback(()=>{if(!l)return 0;const e=new Date,r=new Date(l.birthday);let s=e.getFullYear()-r.getFullYear();const h=e.getMonth()-r.getMonth();return(h<0||h===0&&e.getDate()<r.getDate())&&s--,s},[l]);return{user:l,metrics:p,currentMetrics:m,selectedDateIndex:n,setSelectedDateIndex:d,addMetric:N,updateUser:k,getUserAge:O,settings:o,updateSettings:D,getFormattedWeight:j,getFormattedHeight:R,getFormattedLeanBodyMass:$,loading:y,utils:{lbsToKg:V,kgToLbs:M,cmToFeet:_,cmToInches:Z}}}export{oe as D,J as a,Y as b,W as c,F as d,ce as u};
